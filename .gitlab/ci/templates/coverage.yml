
.coverage-bases:
  stage: coverage

  cache:
    key: "$PHP_VERSION"
    paths:
      - coverage


.coverage-check:
  extends:
    - .bases
    - .coverage-bases

  script:
    - echo '0' >> coverage
    - export saved=`head -n 1 coverage`
    - export coverage=`./vendor/bin/atoum | grep '> Code coverage value:' | sed -E -e 's/\%$//' | awk -F':' '{ print $2 * 100 }'`
    - echo $saved $coverage | awk '{ printf "%+10s %.2f%%\n%+10s %.2f%%\n", "expected", $1 / 100, "got", $2 / 100 }'
    - if [ "$coverage" -lt $saved ]; then exit 1; fi

  cache:
    policy: pull

  except:
    - tags
    - develop
    - master


.coverage-update:
  extends:
    - .bases
    - .coverage-bases

  script:
    - ./vendor/bin/atoum | grep '> Code coverage value:' | sed -E -e 's/\%$//' | awk -F':' '{ print $2 * 100 }' | tee coverage

  only:
    - develop
