
.coverage-check:
  extends: .bases

  stage: coverage

  script:
    - echo '0' >> coverage
    - export saved=`head -n 1 coverage`
    - export coverage=`./vendor/bin/atoum | grep '> Code coverage value:' | sed -E -e 's/\%$//' | awk -F':' '{ print $2 * 100 }'`
    - echo $saved $coverage | awk '{ printf "%+10s %.2f%%\n%+10s %.2f%%\n", "expected", $1 / 100, "got", $2 / 100 }'
    - if [ "$coverage" -lt $saved ]; then exit 1; fi

  cache:
    key: "$PHP_VERSION"
    paths:
      - coverage

  except:
    - tags
    - master
