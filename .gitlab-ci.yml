
variables:
  ATOUM_COVERAGE_FILENAME: "reports/${PHP_VERSION}-coverage.xml"
  ATOUM_XUNIT_FILENAME: "reports/${PHP_VERSION}-xunit.xml"
  BUILD_FILENAME: "lib-php-${CI_COMMIT_TAG}.tar.gz"
  PHPCS_FILENAME: "reports/${PHP_VERSION}-phpcs.json"
  PHPSTAN_FILENAME: "reports/${PHP_VERSION}-stan.json"


notification:mattermost:
  variables:
    MATTERMOST_FILE: "${CI_PROJECT_DIR}/lib-php-${CI_COMMIT_TAG}.tar.gz"
    POST_ICON: https://www.php.net/images/logos/new-php-logo.png

  needs:
    - job: build
      artifacts: true


include:
  - project: 'stancer/ci-template'
    file: '/php.yml'
  - project: 'stancer/ci-template'
    file: '/registry/composer.yml'
  - project: 'stancer/ci-template'
    file: '/notifications/mattermost/library.yml'


phpstan:
  script:
    - mkdir -p $(dirname $PHPSTAN_FILENAME)
    - ./vendor/bin/phpstan analyse --no-progress --error-format=gitlab > $PHPSTAN_FILENAME || true
    - php -r '$f = getenv("PHPSTAN_FILENAME"); $c = json_decode(file_get_contents($f), true); foreach ($c as $k => $v) { if ($v["description"] === "No error to ignore is reported on line 42.") unset($c[$k]); } file_put_contents($f, json_encode($c));'
    - if [ "$(cat $PHPSTAN_FILENAME)" != '[]' ]; then exit 1; fi
