
stages:
  - lint
  - test
  - coverage

.bases:
  before_script:
    - php-version $PHP_VERSIONS
    - php -v
    - composer --version
    - composer install
  tags:
    - php

.atoum:
  extends: .bases
  stage: test
  script: ./vendor/bin/atoum
  coverage: '/Code coverage value: \d+\.\d+%/'
  artifacts:
    reports:
      junit: reports/atoum-$PHP_VERSIONS.xunit.xml

.lint:
  extends: .bases
  stage: lint
  script:
    - mkdir -p reports
    - ./vendor/bin/phpcs --report=junit --report-file=reports/phpcs-$PHP_VERSIONS.junit.xml
  artifacts:
    reports:
      junit: reports/phpcs-$PHP_VERSIONS.junit.xml

.coverage-check:
  extends: .bases
  stage: coverage
  script:
    - echo '0' >> coverage
    - export saved=`head -n 1 coverage`
    - export coverage=`./vendor/bin/atoum | grep '> Code coverage value:' | sed -E -e 's/\%$//' | awk -F':' '{ print $2 * 100 }'`
    - echo $saved $coverage | awk '{ printf "%+10s %.2f%%\n%+10s %.2f%%\n", "expected", $1 / 100, "got", $2 / 100 }'
    - if [ "$coverage" -lt $saved ]; then exit 1; fi
  cache:
    key: "$PHP_VERSIONS"
    paths:
      - coverage
  except:
    - tags
    - master


atoum:PHP7.1:
  variables:
    PHP_VERSIONS: '7.1'
  extends: .atoum

atoum:PHP7.2:
  variables:
    PHP_VERSIONS: '7.2'
  extends: .atoum

atoum:PHP7.3:
  variables:
    PHP_VERSIONS: '7.3'
  extends: .atoum

atoum:PHP7.4:
  variables:
    PHP_VERSIONS: '7.4'
  extends: .atoum
  allow_failure: true


lint:PHP7.1:
  variables:
    PHP_VERSIONS: '7.1'
  extends: .lint

lint:PHP7.2:
  variables:
    PHP_VERSIONS: '7.2'
  extends: .lint

lint:PHP7.3:
  variables:
    PHP_VERSIONS: '7.3'
  extends: .lint

lint:PHP7.4:
  variables:
    PHP_VERSIONS: '7.4'
  extends: .lint
  allow_failure: true


coverage-check PHP 7.1:
  variables:
    PHP_VERSIONS: '7.1'
  extends: .coverage-check

coverage-check PHP 7.2:
  variables:
    PHP_VERSIONS: '7.2'
  extends: .coverage-check

coverage-check PHP 7.3:
  variables:
    PHP_VERSIONS: '7.3'
  extends: .coverage-check

coverage-check PHP 7.4:
  variables:
    PHP_VERSIONS: '7.4'
  extends: .coverage-check
  allow_failure: true
